@using MyMDb.Shared.SearchModel
@inject HttpClient Http

<MudTextField @bind-Value="@SearchTerm" Placeholder="Search for a Movie, Show or Person" OnAdornmentClick="GetResults" OnKeyPress="Submit"
    Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" />

@if (_searching)
{
    <MudProgressLinear @ref="_progress" Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudList Clickable="true" Dense="true" >
        @foreach (SearchMovie movie in _movieResults)
        {
            <MudListItem Href=@($"/movies/{movie.Id}") Text="@movie.Title" Icon="@Icons.TwoTone.Movie" IconColor="@Color.Primary" IconSize="Size.Large" />
        }

        @foreach (SearchPerson person in _personResults)
        {
            <MudListItem Href=@($"/people/{person.Id}") Text="@person.FullName" Icon="@Icons.TwoTone.Person" IconColor="@Color.Primary" IconSize="Size.Large" />
        }
    </MudList>
}

@code {
    private bool _searching = false;
    private MudProgressLinear? _progress;

    [Parameter] public string? SearchTerm { get; set; } = string.Empty;
    private List<SearchMovie> _movieResults = new List<SearchMovie>();
    private List<SearchPerson> _personResults = new List<SearchPerson>();

    private async Task GetResults()
    {
        if (!string.IsNullOrEmpty(SearchTerm))
        {
            _searching = true;
            _movieResults = new List<SearchMovie>();
            _personResults = new List<SearchPerson>();
            StateHasChanged();

            var moviesTask = Http.GetFromJsonAsync<SearchMovie[]>($"api/movie/search?title={SearchTerm}");
            var peopleTask = Http.GetFromJsonAsync<SearchPerson[]>($"api/person/search?name={SearchTerm}");
            await Task.WhenAll(moviesTask, peopleTask);

            var movies = await moviesTask;
            var people = await peopleTask;

            if (movies?.Length > 0)
            {
                _movieResults = new List<SearchMovie>(movies);
            } 

            if (people?.Length > 0)
            {
                _personResults = new List<SearchPerson>(people);
            } 

            _searching = false;
            StateHasChanged();
        }
    }

    private async Task Submit(KeyboardEventArgs args) {
        if (args.Code == "Enter")
        {
            _searching = true;
            await GetResults();
            StateHasChanged();
        }
    }
}
